# 容器网络配置功能优化说明

## 更新概述

基于用户反馈，我们优化了网络配置界面，将原来的"连接已有网络"和"创建新网络"两种模式合并为一个更灵活的"自定义网络配置"模式。

## 优化前的设计问题

### 原设计的三种模式
1. **默认 Bridge 网络** - 使用 Docker 默认网络
2. **连接已有网络** - 只能连接已存在的网络，可配置静态 IP
3. **创建新网络** - 只能创建新网络，不能指定容器的静态 IP

### 存在的问题
用户场景：已有一个 macvlan 网络（如 `mymacvlan`），想连接到这个网络并指定静态 IP。

在原设计中：
- 如果选择"连接已有网络"，可以指定静态 IP，但必须确保网络已存在
- 如果选择"创建新网络"，可以创建网络，但不能为容器指定静态 IP
- 两种模式分离，用户需要明确知道网络是否存在

## 优化后的设计

### 新的两种模式
1. **默认 Bridge 网络** - 保持不变
2. **自定义网络配置** - 统一的网络配置界面

### 自定义网络配置的特点

每个网络配置包含：

#### 1. 基础信息
- **网络名称**（必填）- 要连接的网络名称
- **不存在时自动创建**（开关）- 如果网络不存在是否自动创建

#### 2. 网络创建配置（仅在开启"自动创建"时显示）
- 驱动类型（bridge/overlay/macvlan）
- IPv6 支持
- IPv4 子网和网关
- IPv6 子网和网关
- 其他选项（内部网络、可附加）

**注意**：这些配置仅在网络不存在时用于创建，如果网络已存在则被忽略。

#### 3. 容器连接配置（始终显示）
- 容器 IPv4 地址（静态 IP）
- 容器 IPv6 地址
- 网络别名

## 使用场景示例

### 场景 1：连接到已有的 macvlan 网络并指定静态 IP

您的场景：已有 `mymacvlan` 网络，想指定容器 IP 为 `192.168.1.100`

**操作步骤**：
1. 选择"自定义网络配置"
2. 点击"+ 添加网络"
3. 配置：
   - 网络名称：`mymacvlan`
   - 不存在时自动创建：**关闭**（因为网络已存在）
   - 容器 IPv4 地址：`192.168.1.100`
4. 点击创建

**结果**：容器连接到 `mymacvlan` 网络，使用静态 IP `192.168.1.100`

### 场景 2：创建新网络并指定容器静态 IP

**操作步骤**：
1. 选择"自定义网络配置"
2. 点击"+ 添加网络"
3. 配置：
   - 网络名称：`my-network`
   - 不存在时自动创建：**开启**
   - 驱动类型：`Bridge`
   - IPv4 子网：`172.20.0.0/16`
   - IPv4 网关：`172.20.0.1`
   - 容器 IPv4 地址：`172.20.0.10`
4. 点击创建

**结果**：
- 创建网络 `my-network`（如果不存在）
- 容器连接到该网络，使用静态 IP `172.20.0.10`

### 场景 3：不确定网络是否存在

如果不确定网络是否已创建，可以：
1. 开启"不存在时自动创建"
2. 配置网络创建参数
3. 配置容器连接参数

**结果**：
- 如果网络已存在，直接连接，忽略创建配置
- 如果网络不存在，先创建网络，然后连接

### 场景 4：连接多个网络

可以添加多个网络配置，每个都可以独立设置：
- 是否自动创建
- 网络创建参数
- 容器在该网络中的静态 IP

## 数据结构

### CustomNetworkConfig
```typescript
interface CustomNetworkConfig {
  // 基础信息
  name: string                    // 网络名称（必填）
  createIfNotExists: boolean      // 如果不存在则创建

  // 网络创建配置（仅在 createIfNotExists=true 且网络不存在时使用）
  driver?: 'bridge' | 'overlay' | 'macvlan'
  enableIPv6?: boolean
  ipv4Subnet?: string
  ipv4Gateway?: string
  ipv6Subnet?: string
  ipv6Gateway?: string
  internal?: boolean
  attachable?: boolean

  // 容器连接配置（始终生效）
  containerIPv4Address?: string   // 容器的静态 IPv4 地址
  containerIPv6Address?: string   // 容器的静态 IPv6 地址
  aliases?: string[]              // 网络别名
}
```

## 后端处理逻辑

后端的处理逻辑保持不变：
1. 遍历 `networksToCreate` 列表
2. 对每个网络，检查是否存在
3. 如果不存在，创建网络
4. 如果存在，跳过创建
5. 将容器连接到网络，使用指定的连接配置

## 优势

1. **更灵活** - 一个界面解决所有场景
2. **更简单** - 不需要用户判断网络是否存在
3. **更清晰** - 区分"网络创建配置"和"容器连接配置"
4. **更强大** - 可以为每个网络独立配置静态 IP

## 迁移说明

对于已经熟悉旧界面的用户：
- "连接已有网络" → "自定义网络配置"（关闭"自动创建"）
- "创建新网络" → "自定义网络配置"（开启"自动创建"）

## 技术实现

### 文件更新
- `frontend/src/pages/CreateContainer/types.ts` - 更新类型定义
- `frontend/src/pages/CreateContainer/NetworkTab.vue` - 重构界面
- `frontend/src/pages/CreateContainer/transformer.ts` - 更新数据转换
- `frontend/src/pages/CreateContainer/ContainerCreateView.vue` - 更新默认值

### 验证结果
- ✅ TypeScript 类型检查通过
- ✅ 后端 Go 代码编译通过
- ✅ 无 linter 错误

## 总结

这次优化解决了用户反馈的痛点，提供了更统一、更灵活的网络配置体验。用户现在可以：
- 连接到已有网络并指定静态 IP
- 创建新网络并同时指定容器的静态 IP
- 不用关心网络是否已存在（开启自动创建）
- 在一个界面完成所有网络配置

