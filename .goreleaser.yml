version: 2

# æ³¨æ„ï¼šå‰ç«¯æ„å»ºå·²åœ¨ GitHub Actions ä¸­å®Œæˆï¼Œä¸éœ€è¦åœ¨è¿™é‡Œé‡å¤
# å¦‚æœæœ¬åœ°è¿è¡Œ goreleaserï¼Œè¯·å…ˆæ‰‹åŠ¨æ„å»ºå‰ç«¯ï¼š
# cd frontend && pnpm install && pnpm build
# rm -rf backend/internal/api/static && mkdir -p backend/internal/api/static && cp -r frontend/dist/* backend/internal/api/static/

builds:
  - id: watch-docker
    main: ./cmd/watch-docker
    binary: watch-docker
    dir: ./backend
    env:
      - CGO_ENABLED=0
    goos:
      - linux
      - windows
      - darwin
    goarch:
      - amd64
      - arm64
    # Windows ä¸æ”¯æŒ arm64
    ignore:
      - goos: windows
        goarch: arm64
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}

archives:
  - id: default
    ids:
      - watch-docker
    name_template: >-
      {{ .ProjectName }}_
      {{- .Version }}_
      {{- .Os }}_
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "386" }}i386
      {{- else }}{{ .Arch }}{{ end }}
    # Windows ä½¿ç”¨ ZIPï¼Œå…¶ä»–ä½¿ç”¨ tar.gz
    format_overrides:
      - goos: windows
        formats: ["zip"]
    files:
      - LICENSE
      - README.md
      # å®‰è£…è„šæœ¬ï¼ˆWindows ç”¨ä¸åˆ°ï¼Œä½†åŒ…å«ä¹Ÿæ— å¦¨ï¼‰
      - scripts/install.sh
      - scripts/uninstall.sh
      # macOS launchd é…ç½®æ–‡ä»¶
      - src: scripts/macos/com.watchdocker.plist
        dst: com.watchdocker.plist
      # é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆåˆ†ç¦»ä¸¤ä¸ªæ–‡ä»¶ï¼‰
      - src: app.yaml.example
        dst: app.yaml.example
      - src: config.yaml.example
        dst: config.yaml.example
      # Windows å®‰è£…è¯´æ˜
      - src: ./doc/archive/windows-install.md
        dst: INSTALL-WINDOWS.txt
      # macOS å®‰è£…è¯´æ˜
      - src: ./doc/archive/macos-install.md
        dst: INSTALL-MACOS.md
      # é…ç½®è¯´æ˜æ–‡æ¡£
      - src: ./doc/archive/configuration-guide.md
        dst: CONFIGURATION.md

# Linux è½¯ä»¶åŒ… (DEB/RPM)
nfpms:
  - id: watch-docker
    package_name: watch-docker
    vendor: jianxcao
    homepage: https://github.com/jianxcao/watch-docker
    maintainer: jianxcao <jianxcao@example.com>
    description: |
      Watch Docker - Docker Container Management and Monitoring Tool
      ä¸€ç«™å¼ Docker å®¹å™¨ç›‘æ§ã€æ™ºèƒ½æ›´æ–°ã€å¯è§†åŒ–ç®¡ç†å¹³å°
    license: MIT
    formats:
      - deb
      - rpm
    bindir: /usr/local/bin
    contents:
      # systemd æœåŠ¡æ–‡ä»¶ - æ ‡å‡†æœåŠ¡ï¼ˆæ¨èï¼‰
      - src: ./scripts/systemd/watch-docker.service
        dst: /lib/systemd/system/watch-docker.service
        type: config
      # systemd æœåŠ¡æ–‡ä»¶ - æ¨¡æ¿æœåŠ¡ï¼ˆå¤šç”¨æˆ·ï¼‰
      - src: ./scripts/systemd/watch-docker@.service
        dst: /lib/systemd/system/watch-docker@.service
        type: config
      # å®‰è£…è„šæœ¬
      - src: ./scripts/install-service.sh
        dst: /usr/local/share/watch-docker/install-service.sh
        file_info:
          mode: 0755
      # é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆåˆ†ç¦»ä¸¤ä¸ªæ–‡ä»¶ï¼‰
      - src: ./app.yaml.example
        dst: /usr/local/share/watch-docker/app.yaml.example
      - src: ./config.yaml.example
        dst: /usr/local/share/watch-docker/config.yaml.example
      # æ–‡æ¡£
      - src: ./doc/archive/configuration-guide.md
        dst: /usr/local/share/doc/watch-docker/configuration-guide.md
    scripts:
      postinstall: ./scripts/postinstall.sh
      preremove: ./scripts/preremove.sh
    # overrides:
    #   deb:
    #     dependencies:
    #       - docker.io | docker-ce
    #   rpm:
    #     dependencies:
    #       - docker

# Homebrew Cask (macOS)
# ä½¿ç”¨ homebrew_casks æ›¿ä»£å·²å¼ƒç”¨çš„ brews
# Casks ç”¨äºé¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒFormula ç”¨äºä»æºç ç¼–è¯‘
homebrew_casks:
  - name: watch-docker
    repository:
      owner: jianxcao
      name: homebrew-tap
      token: "{{ .Env.HOMEBREW_TAP_GITHUB_TOKEN }}"
    # Casks é»˜è®¤åœ¨ Casks ç›®å½•ï¼Œä¸éœ€è¦æŒ‡å®š directory
    homepage: https://github.com/jianxcao/watch-docker
    description: Watch Docker - Docker Container Management and Monitoring Tool
    skip_upload: auto
    # æŒ‡å®šäºŒè¿›åˆ¶æ–‡ä»¶å
    binaries:
      - watch-docker
    # å¤„ç† macOS Gatekeeper quarantineï¼ˆå› ä¸ºäºŒè¿›åˆ¶æœªç­¾åï¼‰
    hooks:
      post:
        install: |
          if OS.mac?
            system_command "/usr/bin/xattr", args: ["-dr", "com.apple.quarantine", "#{staged_path}/watch-docker"]
          end
          # åˆ›å»ºé…ç½®ç›®å½•
          (Pathname.new(ENV['HOME'])/".watch-docker").mkpath
    # ç”¨æˆ·æç¤ºä¿¡æ¯
    caveats: |
      ğŸ“¦ å®‰è£…å®Œæˆï¼é…ç½®ç›®å½•ï¼š~/.watch-docker

      ğŸš€ è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ï¼š

      1. æŸ¥æ‰¾ watch-docker å®‰è£…è·¯å¾„ï¼š
         which watch-docker

      2. å¤åˆ¶æä¾›çš„ launchd é…ç½®æ–‡ä»¶ï¼š
         cp "$(brew --prefix)/Caskroom/watch-docker/*/com.watchdocker.plist" ~/Library/LaunchAgents/

      3. ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œç¡®è®¤äºŒè¿›åˆ¶è·¯å¾„æ­£ç¡®ï¼š
         # å¯¹äº Apple Silicon (M1/M2/M3):
         /opt/homebrew/bin/watch-docker
         # å¯¹äº Intel Mac:
         /usr/local/bin/watch-docker

      4. åŠ è½½å¹¶å¯åŠ¨æœåŠ¡ï¼š
         launchctl load ~/Library/LaunchAgents/com.watchdocker.plist
         launchctl start com.watchdocker

      ğŸ“ æœåŠ¡ç®¡ç†å‘½ä»¤ï¼š
         å¯åŠ¨: launchctl start com.watchdocker
         åœæ­¢: launchctl stop com.watchdocker
         é‡å¯: launchctl kickstart -k gui/$(id -u)/com.watchdocker
         æŸ¥çœ‹çŠ¶æ€: launchctl list | grep watchdocker
         å¸è½½è‡ªå¯: launchctl unload ~/Library/LaunchAgents/com.watchdocker.plist

      ğŸ“– æŸ¥çœ‹æ—¥å¿—ï¼š
         tail -f ~/.watch-docker/stdout.log
         tail -f ~/.watch-docker/stderr.log

      âš™ï¸ é»˜è®¤è®¿é—®ï¼šhttp://localhost:8080
         é»˜è®¤ç”¨æˆ·å/å¯†ç ï¼šadmin/admin

# Checksums
checksum:
  name_template: "checksums.txt"

# Changelog
changelog:
  sort: asc
  filters:
    exclude:
      - "^docs:"
      - "^test:"
      - "^chore:"
      - "^ci:"
      - "^build:"
      - "Merge pull request"
      - "Merge branch"

# Release é…ç½®
release:
  github:
    owner: jianxcao
    name: watch-docker
  draft: false
  prerelease: auto
  mode: replace
  header: |
    ## Watch Docker {{ .Tag }}

    ### ğŸ“¦ å®‰è£…æ–¹å¼

    #### Linux (Debian/Ubuntu)
    ```bash
    wget https://github.com/jianxcao/watch-docker/releases/download/{{ .Tag }}/watch-docker_{{ .Version }}_linux_x86_64.deb
    sudo dpkg -i watch-docker_{{ .Version }}_linux_x86_64.deb
    ```

    #### Linux (RHEL/CentOS/Fedora)
    ```bash
    wget https://github.com/jianxcao/watch-docker/releases/download/{{ .Tag }}/watch-docker_{{ .Version }}_linux_x86_64.rpm
    sudo rpm -i watch-docker_{{ .Version }}_linux_x86_64.rpm
    ```

    #### macOS (Homebrew)
    ```bash
    brew tap jianxcao/tap
    brew install watch-docker
    ```

    #### Windows
    ä¸‹è½½å¹¶è¿è¡Œ `WatchDocker-Setup.exe`

    #### ç‹¬ç«‹äºŒè¿›åˆ¶
    ä»ä¸‹æ–¹ Assets ä¸­ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…ï¼Œè§£å‹åç›´æ¥è¿è¡Œã€‚

    ---
  footer: |
    ---

    **å®Œæ•´æ›´æ–°æ—¥å¿—**: https://github.com/jianxcao/watch-docker/compare/{{ .PreviousTag }}...{{ .Tag }}

# Announce (å¯é€‰)
# announce:
#   discord:
#     enabled: true
#     message_template: 'Watch Docker {{ .Tag }} is out! Check it out at {{ .ReleaseURL }}'
