{"version":3,"file":"useXhrUpload-DwU_B2wy.js","names":[],"sources":["../../src/hooks/useXhrUpload.ts"],"sourcesContent":["import { ref } from 'vue'\nimport { useMessage } from 'naive-ui'\nimport { formatBytes } from '@/common/utils'\n\nexport interface UploadOptions {\n  url: string\n  file: File\n  formData?: FormData\n  getToken?: () => string\n  onSuccess?: (response: any) => void\n  onError?: (error: any) => void\n}\n\nexport function useXhrUpload() {\n  const message = useMessage()\n\n  // 上传状态\n  const uploading = ref(false)\n  const uploadProgress = ref(0)\n  const uploadedSize = ref(0)\n  const totalSize = ref(0)\n  const currentFileName = ref('')\n  const uploadSpeed = ref('')\n\n  // 重置状态\n  const resetState = () => {\n    uploading.value = false\n    uploadProgress.value = 0\n    uploadedSize.value = 0\n    totalSize.value = 0\n    currentFileName.value = ''\n    uploadSpeed.value = ''\n  }\n\n  // 执行上传\n  const upload = async (options: UploadOptions): Promise<void> => {\n    const { url, file, formData = new FormData(), getToken, onSuccess, onError } = options\n\n    if (!formData.has('file')) {\n      formData.append('file', file)\n    }\n\n    uploading.value = true\n    currentFileName.value = file.name\n    totalSize.value = file.size\n\n    const startTime = Date.now()\n    let lastLoaded = 0\n    let lastTime = startTime\n\n    return new Promise((resolve, reject) => {\n      const xhr = new XMLHttpRequest()\n\n      // 监听上传进度\n      xhr.upload.addEventListener('progress', (event) => {\n        if (event.lengthComputable) {\n          const progress = Math.round((event.loaded / event.total) * 100)\n          uploadProgress.value = progress\n          uploadedSize.value = event.loaded\n\n          // 计算上传速度\n          const currentTime = Date.now()\n          const timeDiff = currentTime - lastTime\n          if (timeDiff > 1000) {\n            // 每秒更新一次速度\n            const sizeDiff = event.loaded - lastLoaded\n            const speedBps = sizeDiff / (timeDiff / 1000)\n            uploadSpeed.value = `${formatBytes(speedBps)}/s`\n            lastLoaded = event.loaded\n            lastTime = currentTime\n          }\n        }\n      })\n\n      // 处理响应\n      xhr.addEventListener('load', () => {\n        uploading.value = false\n        if (xhr.status === 200) {\n          try {\n            const response = JSON.parse(xhr.responseText)\n            if (response.code === 0) {\n              onSuccess?.(response)\n              resolve()\n            } else {\n              const errorMsg = response.msg || '上传失败'\n              message.error(errorMsg)\n              onError?.(response)\n              reject(new Error(errorMsg))\n            }\n          } catch (err) {\n            console.error('响应解析失败:', err)\n            const errorMsg = '响应解析失败'\n            message.error(errorMsg)\n            onError?.(err)\n            reject(new Error(errorMsg))\n          }\n        } else {\n          const errorMsg = `上传失败 (${xhr.status})`\n          message.error(errorMsg)\n          onError?.(new Error(errorMsg))\n          reject(new Error(errorMsg))\n        }\n      })\n\n      xhr.addEventListener('error', () => {\n        const errorMsg = '网络错误'\n        message.error(errorMsg)\n        uploading.value = false\n        onError?.(new Error(errorMsg))\n        reject(new Error(errorMsg))\n      })\n\n      // 获取认证token并发送请求\n      try {\n        const token = getToken ? getToken() : ''\n\n        xhr.open('POST', url)\n        if (token) {\n          xhr.setRequestHeader('Authorization', `Bearer ${token}`)\n        }\n        xhr.send(formData)\n      } catch (err) {\n        console.error('获取token失败:', err)\n        const errorMsg = '获取认证信息失败'\n        message.error(errorMsg)\n        uploading.value = false\n        onError?.(err)\n        reject(new Error(errorMsg))\n      }\n    })\n  }\n\n  return {\n    // 状态\n    uploading,\n    uploadProgress,\n    uploadedSize,\n    totalSize,\n    currentFileName,\n    uploadSpeed,\n    // 方法\n    resetState,\n    upload,\n    formatFileSize: formatBytes,\n  }\n}\n"],"mappings":"qFAaA,SAAgB,GAAe,CAC7B,IAAM,EAAU,GAAY,CAGtB,EAAY,EAAI,GAAM,CACtB,EAAiB,EAAI,EAAE,CACvB,EAAe,EAAI,EAAE,CACrB,EAAY,EAAI,EAAE,CAClB,EAAkB,EAAI,GAAG,CACzB,EAAc,EAAI,GAAG,CA8G3B,MAAO,CAEL,YACA,iBACA,eACA,YACA,kBACA,cAEA,eApHuB,CACvB,EAAU,MAAQ,GAClB,EAAe,MAAQ,EACvB,EAAa,MAAQ,EACrB,EAAU,MAAQ,EAClB,EAAgB,MAAQ,GACxB,EAAY,MAAQ,IA+GpB,OA3Ga,KAAO,IAA0C,CAC9D,GAAM,CAAE,MAAK,OAAM,WAAW,IAAI,SAAY,WAAU,YAAW,WAAY,EAE1E,EAAS,IAAI,OAAO,EACvB,EAAS,OAAO,OAAQ,EAAK,CAG/B,EAAU,MAAQ,GAClB,EAAgB,MAAQ,EAAK,KAC7B,EAAU,MAAQ,EAAK,KAEvB,IAAM,EAAY,KAAK,KAAK,CACxB,EAAa,EACb,EAAW,EAEf,OAAO,IAAI,SAAS,EAAS,IAAW,CACtC,IAAM,EAAM,IAAI,eAGhB,EAAI,OAAO,iBAAiB,WAAa,GAAU,CACjD,GAAI,EAAM,iBAAkB,CAE1B,EAAe,MADE,KAAK,MAAO,EAAM,OAAS,EAAM,MAAS,IAAI,CAE/D,EAAa,MAAQ,EAAM,OAG3B,IAAM,EAAc,KAAK,KAAK,CACxB,EAAW,EAAc,EAC3B,EAAW,MAIb,EAAY,MAAQ,GAAG,GAFN,EAAM,OAAS,IACH,EAAW,KACI,CAAC,IAC7C,EAAa,EAAM,OACnB,EAAW,KAGf,CAGF,EAAI,iBAAiB,WAAc,CAEjC,GADA,EAAU,MAAQ,GACd,EAAI,SAAW,IACjB,GAAI,CACF,IAAM,EAAW,KAAK,MAAM,EAAI,aAAa,CAC7C,GAAI,EAAS,OAAS,EACpB,IAAY,EAAS,CACrB,GAAS,KACJ,CACL,IAAM,EAAW,EAAS,KAAO,OACjC,EAAQ,MAAM,EAAS,CACvB,IAAU,EAAS,CACnB,EAAW,MAAM,EAAS,CAAC,QAEtB,EAAK,CACZ,QAAQ,MAAM,UAAW,EAAI,CAC7B,IAAM,EAAW,SACjB,EAAQ,MAAM,EAAS,CACvB,IAAU,EAAI,CACd,EAAW,MAAM,EAAS,CAAC,KAExB,CACL,IAAM,EAAW,SAAS,EAAI,OAAO,GACrC,EAAQ,MAAM,EAAS,CACvB,IAAc,MAAM,EAAS,CAAC,CAC9B,EAAW,MAAM,EAAS,CAAC,GAE7B,CAEF,EAAI,iBAAiB,YAAe,CAClC,IAAM,EAAW,OACjB,EAAQ,MAAM,EAAS,CACvB,EAAU,MAAQ,GAClB,IAAc,MAAM,EAAS,CAAC,CAC9B,EAAW,MAAM,EAAS,CAAC,EAC3B,CAGF,GAAI,CACF,IAAM,EAAQ,EAAW,GAAU,CAAG,GAEtC,EAAI,KAAK,OAAQ,EAAI,CACjB,GACF,EAAI,iBAAiB,gBAAiB,UAAU,IAAQ,CAE1D,EAAI,KAAK,EAAS,OACX,EAAK,CACZ,QAAQ,MAAM,aAAc,EAAI,CAChC,IAAM,EAAW,WACjB,EAAQ,MAAM,EAAS,CACvB,EAAU,MAAQ,GAClB,IAAU,EAAI,CACd,EAAW,MAAM,EAAS,CAAC,GAE7B,EAcF,eAAgB,EACjB"}