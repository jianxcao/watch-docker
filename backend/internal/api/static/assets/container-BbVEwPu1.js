const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/axiosConfig-BTZ6bNNN.js","assets/index-KvlnPhMc.js","assets/ui-CdsL-WMe.js","assets/common-B7iQJWwr.js","assets/rolldown-runtime-DGruFWvd.js","assets/index-Cyqp8d2B.css"])))=>i.map(i=>d[i]);
import{Gt as e,kn as t}from"./ui-CdsL-WMe.js";import{c as n,d as r}from"./common-B7iQJWwr.js";import{h as i,n as a,o}from"./index-KvlnPhMc.js";function s(e){return{all:e||=new Map,on:function(t,n){var r=e.get(t);r?r.push(n):e.set(t,[n])},off:function(t,n){var r=e.get(t);r&&(n?r.splice(r.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var r=e.get(t);r&&r.slice().map(function(e){e(n)}),(r=e.get(`*`))&&r.slice().map(function(e){e(t,n)})}}}var c=s();function l(){let t=a(),r=e(()=>{let e=t.getToken();if(e)return`${window.location.protocol===`https:`?`wss:`:`ws:`}//${window.location.host}/api/v1/containers/stats/ws?token=${e}`}),{status:i,send:o,open:s,close:l,ws:u}=n(r,{autoReconnect:{retries:5,delay:2e3,onFailed(){console.error(`WebSocket 重连失败，已达到最大重试次数`)}},heartbeat:!1,immediate:!1,autoConnect:!0,autoClose:!0,onConnected(e){console.log(`Stats WebSocket 连接已建立`),e&&(e.binaryType=`arraybuffer`)},onDisconnected(e,t){console.log(`Stats WebSocket 连接已断开:`,t.code,t.reason),t.code===1006&&console.warn(`WebSocket 异常关闭 (1006)，可能是网络问题或服务端问题`)},onError(e,t){console.error(`Stats WebSocket 连接错误:`,t)},onMessage(e,t){try{let e;if(t.data instanceof ArrayBuffer)e=new TextDecoder(`utf-8`).decode(t.data);else if(typeof t.data==`string`)e=t.data;else{console.error(`未知的消息类型:`,typeof t.data);return}try{let t=JSON.parse(e);t.type===`containers`&&t.data.containers&&c.emit(`containers`,t.data.containers)}catch(t){console.error(`解析 JSON 消息失败:`,t,`Data:`,e)}}catch(e){console.error(`处理 WebSocket 消息失败:`,e)}}}),d=e(()=>{switch(i.value){case`CONNECTING`:return`connecting`;case`OPEN`:return`connected`;case`CLOSED`:return`disconnected`;default:return`disconnected`}}),f=e(()=>i.value===`OPEN`),p=()=>{f.value||(console.debug(`connect`),r.value?s():console.warn(`无法启动 WebSocket 连接：缺少有效的 token`))},m=()=>{l()};return{status:i,connectionState:d,isConnected:f,ws:u,connect:p,disconnect:m,reconnect:()=>{console.debug(`reconnect`),i.value===`OPEN`&&m(),setTimeout(()=>{p()},100)},send:o}}const u=r(`container`,()=>{let n=t([]),r=t(!1),a=t(new Set),s=t(!1),u=l(),d=e(()=>u.isConnected.value),f=e(()=>u.connectionState.value),p=e(()=>n.value.filter(e=>e.running)),m=e(()=>n.value.filter(e=>!e.running)),h=e(()=>n.value.filter(e=>e.status===`UpdateAvailable`&&!e.skipped)),g=e(()=>n.value.filter(e=>e.status===`UpToDate`)),_=e(()=>n.value.filter(e=>e.status===`Error`)),v=e(()=>n.value.filter(e=>e.skipped)),y=e(()=>({total:n.value.length,running:p.value.length,stopped:m.value.length,updateable:h.value.length,upToDate:g.value.length,error:_.value.length,skipped:v.value.length})),b=async(e=!0,t=!0)=>{r.value=!0;try{let r=await o.getContainers(e,t);if(r.code===0){let e=r.data.containers,t=new Map(n.value.map(e=>[e.id,e]));n.value=e.map(e=>{let n=t.get(e.id);return n?{...n,...e}:e})}else throw console.error(`获取容器列表失败:`,r.msg),Error(r.msg)}catch(e){throw console.error(`获取容器列表失败:`,e),e}finally{r.value=!1}};return c.on(`containers`,e=>{let t=new Map;e.forEach(e=>{t.set(e.id,e)}),n.value=[...n.value].map(e=>t.get(e.id)||e)}),{containers:n,loading:r,updating:a,batchUpdating:s,wsConnected:d,wsConnectionState:f,runningContainers:p,stoppedContainers:m,updateableContainers:h,upToDateContainers:g,errorContainers:_,skippedContainers:v,stats:y,fetchContainers:b,updateContainer:async(e,t)=>{a.value.add(e);try{let n=await o.updateContainer(e,t);if(n.code===0)return await b(),!0;throw Error(n.msg)}catch(e){throw console.error(`更新容器失败:`,e),e}finally{a.value.delete(e)}},batchUpdate:async()=>{s.value=!0;try{let e=await o.batchUpdate();if(e.code===0)return await b(),e.data;throw Error(e.msg)}catch(e){throw console.error(`批量更新失败:`,e),e}finally{s.value=!1}},startContainer:async e=>{try{let t=await o.startContainer(e);if(t.code===0)return await b(),!0;throw Error(t.msg)}catch(e){throw console.error(`启动容器失败:`,e),e}},stopContainer:async e=>{try{let t=await o.stopContainer(e);if(t.code===0)return await b(),!0;throw Error(t.msg)}catch(e){throw console.error(`停止容器失败:`,e),e}},restartContainer:async e=>{try{let t=await o.restartContainer(e);if(t.code===0)return await b(),!0;throw Error(t.msg)}catch(e){throw console.error(`重启容器失败:`,e),e}},deleteContainer:async(e,t=!1,n=!1,r=!1)=>{try{let i=await o.deleteContainer(e,t,n,r);if(i.code===0)return await b(),!0;throw Error(i.msg)}catch(e){throw console.error(`删除容器失败:`,e),e}},findContainerById:e=>n.value.find(t=>t.id===e),findContainerByName:e=>n.value.find(t=>t.name===e),getProjectContainers:t=>e(()=>n.value.filter(e=>e.labels?.[`com.docker.compose.project`]===t)),isContainerUpdating:e=>a.value.has(e),exportContainer:async e=>{try{let{getToken:t}=await i(async()=>{let{getToken:e}=await import(`./axiosConfig-BTZ6bNNN.js`);return{getToken:e}},__vite__mapDeps([0,1,2,3,4,5])),n=t(),r=`/api/v1/containers/${e}/export?token=${encodeURIComponent(n)}&_t=${Date.now()}`;if(!window.open(r,`_blank`))throw Error(`浏览器阻止了弹窗，请允许弹窗后重试`);return!0}catch(e){throw console.error(`导出容器失败:`,e),e}},getContainerDetail:async e=>{try{let t=await o.getContainerDetail(e);if(t.code===0)return t.data.container;throw Error(t.msg)}catch(e){throw console.error(`获取容器详情失败:`,e),e}},statsWebSocket:u}});export{c as n,u as t};
//# sourceMappingURL=container-BbVEwPu1.js.map