{"version":3,"file":"compose-CNk9ZZLk.js","names":[],"sources":["../../src/store/compose.ts"],"sourcesContent":["import { composeApi } from '@/common/api'\nimport type { ComposeAction, ComposeProject } from '@/common/types'\nimport { defineStore } from 'pinia'\nimport { computed, ref } from 'vue'\n\nexport const useComposeStore = defineStore('compose', () => {\n  const message = window.$message\n\n  // 状态\n  const projects = ref<ComposeProject[]>([])\n  const loading = ref(false)\n  const operationLoading = ref<Record<string, boolean>>({})\n\n  const stats = computed(() => ({\n    total: projects.value.length,\n    running: projects.value.filter((p) => p.status === 'running').length,\n    exited: projects.value.filter((p) => p.status === 'exited').length,\n    draft: projects.value.filter((p) => p.status === 'draft').length,\n    createdStack: projects.value.filter((p) => p.status === 'created_stack').length,\n  }))\n\n  // 检查项目是否正在执行操作\n  const isProjectOperating = (projectName: string) => {\n    return computed(() => operationLoading.value[projectName] || false)\n  }\n\n  // 设置项目操作状态\n  const setProjectOperating = (projectName: string, isOperating: boolean) => {\n    operationLoading.value[projectName] = isOperating\n  }\n\n  // 获取项目列表\n  const fetchProjects = async (force = false) => {\n    if (loading.value && !force) {\n      return\n    }\n\n    loading.value = true\n    try {\n      const response = await composeApi.getProjects()\n      if (response.code === 0) {\n        projects.value = response.data.projects || []\n      } else {\n        throw new Error(response.msg || '获取项目列表失败')\n      }\n    } catch (error) {\n      console.error('获取 Compose 项目列表失败:', error)\n      message.error(`获取 Compose 项目列表失败: ${(error as Error).message}`)\n      throw error\n    } finally {\n      loading.value = false\n    }\n  }\n\n  // 执行项目操作\n  const executeProjectAction = async (\n    project: ComposeProject,\n    action: ComposeAction,\n    options?: { refreshAfter?: boolean },\n  ) => {\n    const { refreshAfter = true } = options || {}\n\n    setProjectOperating(project.name, true)\n\n    try {\n      let response\n      let actionText = ''\n\n      switch (action) {\n        case 'start':\n          response = await composeApi.startProject(project)\n          actionText = '启动'\n          break\n        case 'stop':\n          response = await composeApi.stopProject(project)\n          actionText = '停止'\n          break\n        case 'restart':\n          response = await composeApi.restartProject(project)\n          actionText = '重启'\n          break\n        case 'delete':\n          response = await composeApi.deleteProject(project)\n          actionText = '删除'\n          break\n        case 'create':\n          response = await composeApi.createProject(project)\n          actionText = '创建'\n          break\n        default:\n          throw new Error(`未知操作: ${action}`)\n      }\n\n      if (response.code === 0) {\n        message.success(`${actionText}项目成功`)\n        if (refreshAfter) {\n          await fetchProjects(true)\n        }\n      } else {\n        throw new Error(response.msg || `${actionText}项目失败`)\n      }\n    } catch (error) {\n      console.error(`执行项目操作失败:`, error)\n      const actionText = {\n        start: '启动',\n        stop: '停止',\n        restart: '重新创建',\n        delete: '删除',\n        create: '创建',\n      }[action]\n      message.error(`${actionText}项目失败: ${(error as Error).message}`)\n      throw error\n    } finally {\n      setProjectOperating(project.name, false)\n    }\n  }\n\n  // 启动项目\n  const startProject = async (app: ComposeProject) => {\n    return executeProjectAction(app, 'start')\n  }\n\n  // 停止项目\n  const stopProject = async (app: ComposeProject) => {\n    return executeProjectAction(app, 'stop')\n  }\n\n  // 重新创建项目\n  const restartProject = async (app: ComposeProject) => {\n    return executeProjectAction(app, 'restart')\n  }\n\n  // 删除项目\n  const deleteProject = async (app: ComposeProject) => {\n    return executeProjectAction(app, 'delete')\n  }\n\n  const createProject = async (app: ComposeProject) => {\n    return executeProjectAction(app, 'create')\n  }\n\n  // 保存新项目（创建目录和 YAML 文件）\n  const saveNewProject = async (name: string, yamlContent: string) => {\n    try {\n      const response = await composeApi.saveNewProject(name, yamlContent)\n      if (response.code === 0) {\n        message.success('项目保存成功')\n        return response.data\n      } else {\n        throw new Error(response.msg || '保存项目失败')\n      }\n    } catch (error) {\n      console.error('保存项目失败:', error)\n      message.error(`保存项目失败: ${(error as Error).message}`)\n      throw error\n    }\n  }\n\n  // 获取项目日志\n  const getProjectLogs = async (projectName: string, lines = 100) => {\n    try {\n      const response = await composeApi.getProjectLogs(projectName, lines)\n      if (response.code === 0) {\n        return response.data.logs || ''\n      } else {\n        throw new Error(response.msg || '获取日志失败')\n      }\n    } catch (error) {\n      console.error('获取项目日志失败:', error)\n      message.error(`获取项目日志失败: ${(error as Error).message}`)\n      throw error\n    }\n  }\n\n  // 获取项目的 YAML 内容\n  const getProjectYaml = async (projectName: string, composeFile: string) => {\n    try {\n      const response = await composeApi.getProjectYaml(projectName, composeFile)\n      if (response.code === 0) {\n        return response.data.yamlContent || ''\n      } else {\n        throw new Error(response.msg || '获取 YAML 内容失败')\n      }\n    } catch (error) {\n      console.error('获取项目 YAML 失败:', error)\n      message.error(`获取项目 YAML 失败: ${(error as Error).message}`)\n      throw error\n    }\n  }\n\n  // 根据名称查找项目\n  const findProject = (name: string) => {\n    return computed(() => projects.value.find((p) => p.name === name))\n  }\n\n  // 清空所有状态\n  const clearAll = () => {\n    projects.value = []\n    operationLoading.value = {}\n    loading.value = false\n  }\n\n  return {\n    // 状态\n    projects,\n    loading,\n    operationLoading,\n    stats,\n\n    // 工具函数\n    isProjectOperating,\n    setProjectOperating,\n    findProject,\n\n    // 操作方法\n    fetchProjects,\n    executeProjectAction,\n    startProject,\n    stopProject,\n    restartProject,\n    deleteProject,\n    createProject,\n    saveNewProject,\n    getProjectLogs,\n    getProjectYaml,\n    clearAll,\n  }\n})\n"],"mappings":"+HAKA,MAAa,EAAkB,EAAY,cAAiB,CAC1D,IAAM,EAAU,OAAO,SAGjB,EAAW,EAAsB,EAAE,CAAC,CACpC,EAAU,EAAI,GAAM,CACpB,EAAmB,EAA6B,EAAE,CAAC,CAEnD,EAAQ,OAAgB,CAC5B,MAAO,EAAS,MAAM,OACtB,QAAS,EAAS,MAAM,OAAQ,GAAM,EAAE,SAAW,UAAU,CAAC,OAC9D,OAAQ,EAAS,MAAM,OAAQ,GAAM,EAAE,SAAW,SAAS,CAAC,OAC5D,MAAO,EAAS,MAAM,OAAQ,GAAM,EAAE,SAAW,QAAQ,CAAC,OAC1D,aAAc,EAAS,MAAM,OAAQ,GAAM,EAAE,SAAW,gBAAgB,CAAC,OAC1E,EAAE,CAGG,EAAsB,GACnB,MAAe,EAAiB,MAAM,IAAgB,GAAM,CAI/D,GAAuB,EAAqB,IAAyB,CACzE,EAAiB,MAAM,GAAe,GAIlC,EAAgB,MAAO,EAAQ,KAAU,CACzC,OAAQ,OAAS,CAAC,GAItB,GAAQ,MAAQ,GAChB,GAAI,CACF,IAAM,EAAW,MAAM,EAAW,aAAa,CAC/C,GAAI,EAAS,OAAS,EACpB,EAAS,MAAQ,EAAS,KAAK,UAAY,EAAE,MAE7C,MAAU,MAAM,EAAS,KAAO,WAAW,OAEtC,EAAO,CAGd,MAFA,QAAQ,MAAM,qBAAsB,EAAM,CAC1C,EAAQ,MAAM,sBAAuB,EAAgB,UAAU,CACzD,SACE,CACR,EAAQ,MAAQ,MAKd,EAAuB,MAC3B,EACA,EACA,IACG,CACH,GAAM,CAAE,eAAe,IAAS,GAAW,EAAE,CAE7C,EAAoB,EAAQ,KAAM,GAAK,CAEvC,GAAI,CACF,IAAI,EACA,EAAa,GAEjB,OAAQ,EAAR,CACE,IAAK,QACH,EAAW,MAAM,EAAW,aAAa,EAAQ,CACjD,EAAa,KACb,MACF,IAAK,OACH,EAAW,MAAM,EAAW,YAAY,EAAQ,CAChD,EAAa,KACb,MACF,IAAK,UACH,EAAW,MAAM,EAAW,eAAe,EAAQ,CACnD,EAAa,KACb,MACF,IAAK,SACH,EAAW,MAAM,EAAW,cAAc,EAAQ,CAClD,EAAa,KACb,MACF,IAAK,SACH,EAAW,MAAM,EAAW,cAAc,EAAQ,CAClD,EAAa,KACb,MACF,QACE,MAAU,MAAM,SAAS,IAAS,CAGtC,GAAI,EAAS,OAAS,EACpB,EAAQ,QAAQ,GAAG,EAAW,MAAM,CAChC,GACF,MAAM,EAAc,GAAK,MAG3B,MAAU,MAAM,EAAS,KAAO,GAAG,EAAW,MAAM,OAE/C,EAAO,CACd,QAAQ,MAAM,YAAa,EAAM,CACjC,IAAM,EAAa,CACjB,MAAO,KACP,KAAM,KACN,QAAS,OACT,OAAQ,KACR,OAAQ,KACT,CAAC,GAEF,MADA,EAAQ,MAAM,GAAG,EAAW,QAAS,EAAgB,UAAU,CACzD,SACE,CACR,EAAoB,EAAQ,KAAM,GAAM,GAyF5C,MAAO,CAEL,WACA,UACA,mBACA,QAGA,qBACA,sBACA,YArBmB,GACZ,MAAe,EAAS,MAAM,KAAM,GAAM,EAAE,OAAS,EAAK,CAAC,CAuBlE,gBACA,uBACA,aAnGmB,KAAO,IACnB,EAAqB,EAAK,QAAQ,CAmGzC,YA/FkB,KAAO,IAClB,EAAqB,EAAK,OAAO,CA+FxC,eA3FqB,KAAO,IACrB,EAAqB,EAAK,UAAU,CA2F3C,cAvFoB,KAAO,IACpB,EAAqB,EAAK,SAAS,CAuF1C,cApFoB,KAAO,IACpB,EAAqB,EAAK,SAAS,CAoF1C,eAhFqB,MAAO,EAAc,IAAwB,CAClE,GAAI,CACF,IAAM,EAAW,MAAM,EAAW,eAAe,EAAM,EAAY,CACnE,GAAI,EAAS,OAAS,EAEpB,OADA,EAAQ,QAAQ,SAAS,CAClB,EAAS,KAEhB,MAAU,MAAM,EAAS,KAAO,SAAS,OAEpC,EAAO,CAGd,MAFA,QAAQ,MAAM,UAAW,EAAM,CAC/B,EAAQ,MAAM,WAAY,EAAgB,UAAU,CAC9C,IAqER,eAhEqB,MAAO,EAAqB,EAAQ,MAAQ,CACjE,GAAI,CACF,IAAM,EAAW,MAAM,EAAW,eAAe,EAAa,EAAM,CACpE,GAAI,EAAS,OAAS,EACpB,OAAO,EAAS,KAAK,MAAQ,GAE7B,MAAU,MAAM,EAAS,KAAO,SAAS,OAEpC,EAAO,CAGd,MAFA,QAAQ,MAAM,YAAa,EAAM,CACjC,EAAQ,MAAM,aAAc,EAAgB,UAAU,CAChD,IAsDR,eAjDqB,MAAO,EAAqB,IAAwB,CACzE,GAAI,CACF,IAAM,EAAW,MAAM,EAAW,eAAe,EAAa,EAAY,CAC1E,GAAI,EAAS,OAAS,EACpB,OAAO,EAAS,KAAK,aAAe,GAEpC,MAAU,MAAM,EAAS,KAAO,eAAe,OAE1C,EAAO,CAGd,MAFA,QAAQ,MAAM,gBAAiB,EAAM,CACrC,EAAQ,MAAM,iBAAkB,EAAgB,UAAU,CACpD,IAuCR,aA7BqB,CACrB,EAAS,MAAQ,EAAE,CACnB,EAAiB,MAAQ,EAAE,CAC3B,EAAQ,MAAQ,IA2BjB,EACD"}