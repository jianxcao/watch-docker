{"version":3,"mappings":"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","names":["error: any"],"ignoreList":[],"sources":["../../src/store/image.ts"],"sourcesContent":["import { imageApi } from '@/common/api'\nimport type { ImageInfo } from '@/common/types'\nimport { formatBytes } from '@/common/utils'\nimport { defineStore } from 'pinia'\nimport { computed, ref } from 'vue'\nexport const useImageStore = defineStore('image', () => {\n  // 状态\n  const images = ref<ImageInfo[]>([])\n  const loading = ref(false)\n  const deleting = ref(new Set<string>())\n  const downloading = ref(new Set<string>())\n  const importing = ref(false)\n\n  // 方法：检查镜像是否为悬空镜像（dangling image）\n  const isDanglingImage = (image: ImageInfo): boolean => {\n    return (\n      !image.repoTags ||\n      image.repoTags.length === 0 ||\n      image.repoTags.every((tag) => tag === '<none>:<none>')\n    )\n  }\n\n  const normalImages = computed(() => images.value.filter((image) => !isDanglingImage(image)))\n\n  // 计算属性\n  const totalImages = computed(() => normalImages.value.length)\n\n  const totalSize = computed(() => normalImages.value.reduce((sum, img) => sum + img.size, 0))\n\n  // 格式化的总大小\n  const formattedTotalSize = computed(() => formatBytes(totalSize.value))\n\n  // 统计信息\n  const stats = computed(() => ({\n    total: totalImages.value,\n    totalSize: totalSize.value,\n    formattedTotalSize: formattedTotalSize.value,\n  }))\n\n  // 方法：获取镜像列表\n  const fetchImages = async () => {\n    loading.value = true\n    try {\n      const data = await imageApi.getImages()\n      if (data.code === 0) {\n        images.value = data.data.images\n      } else {\n        console.error('获取镜像列表失败:', data.msg)\n        throw new Error(data.msg)\n      }\n    } catch (error) {\n      console.error('获取镜像列表失败:', error)\n      throw error\n    } finally {\n      loading.value = false\n    }\n  }\n\n  // 方法：定时获取镜像列表\n  const { pause: stopImagesPolling, resume: startImagesPolling } = useIntervalFn(\n    fetchImages,\n    10000,\n    {\n      immediate: false,\n    }\n  )\n\n  // 方法：删除镜像\n  const deleteImage = async (ref: string, force: boolean = false): Promise<boolean> => {\n    deleting.value.add(ref)\n    try {\n      const data = await imageApi.deleteImage(ref, force)\n      if (data.code === 0) {\n        await fetchImages() // 重新获取列表\n        return true\n      } else {\n        throw new Error(data.msg)\n      }\n    } catch (error) {\n      console.error('删除镜像失败:', error)\n      throw error\n    } finally {\n      deleting.value.delete(ref)\n    }\n  }\n\n  // 方法：根据ID查找镜像\n  const findImageById = (id: string) => {\n    return images.value.find((img) => img.id === id)\n  }\n\n  // 方法：根据标签查找镜像\n  const findImagesByTag = (tag: string) => {\n    return images.value.filter((img) => img.repoTags.some((repoTag) => repoTag.includes(tag)))\n  }\n\n  // 方法：检查镜像是否正在删除\n  const isImageDeleting = (ref: string) => {\n    return deleting.value.has(ref)\n  }\n\n  // 方法：检查镜像是否正在下载\n  const isImageDownloading = (ref: string) => {\n    return downloading.value.has(ref)\n  }\n\n  // 方法：下载镜像\n  const downloadImage = async (id: string): Promise<boolean> => {\n    downloading.value.add(id)\n    try {\n      // 获取当前的token\n      const { getToken } = await import('@/common/axiosConfig')\n      const token = getToken()\n\n      // 构建下载URL，将token作为查询参数\n      const baseUrl = '/api/v1'\n      const downloadUrl = `${baseUrl}/images/${id}/download?token=${encodeURIComponent(\n        token\n      )}&_t=${Date.now()}`\n\n      // 使用window.open直接下载，浏览器会处理大文件和进度\n      const downloadWindow = window.open(downloadUrl, '_blank')\n\n      // 检查是否成功打开了下载窗口\n      if (!downloadWindow) {\n        throw new Error('浏览器阻止了弹窗，请允许弹窗后重试')\n      }\n\n      // 设置一个短暂的延迟来清除下载状态\n      setTimeout(() => {\n        downloading.value.delete(id)\n      }, 1000)\n\n      return true\n    } catch (error: any) {\n      console.error('下载镜像失败:', error)\n      downloading.value.delete(id)\n      throw error\n    }\n  }\n\n  // 方法：导入镜像\n  const importImage = async (file: File): Promise<boolean> => {\n    importing.value = true\n    try {\n      const response = await imageApi.importImage(file)\n      if (response.code === 0) {\n        await fetchImages() // 重新获取镜像列表\n        return true\n      } else {\n        throw new Error(response.msg || '导入失败')\n      }\n    } catch (error: any) {\n      console.error('导入镜像失败:', error)\n      if (error.response?.data?.error) {\n        throw new Error(error.response.data.error)\n      }\n      throw error\n    } finally {\n      importing.value = false\n    }\n  }\n\n  // 方法：获取镜像的主要标签（用于显示）\n  const getImageDisplayTag = (image: ImageInfo): string => {\n    if (image.repoTags && image.repoTags.length > 0) {\n      // 过滤掉 <none>:<none> 标签\n      const validTags = image.repoTags.filter((tag) => tag !== '<none>:<none>')\n      if (validTags.length > 0) {\n        return validTags[0]\n      }\n    }\n    // 如果没有有效标签，返回短ID\n    return image.id.startsWith('sha256:') ? image.id.slice(7, 19) : image.id.slice(0, 12)\n  }\n\n  // 计算悬空镜像\n  const danglingImages = computed(() => images.value.filter((img) => isDanglingImage(img)))\n\n  // 方法：获取镜像的摘要显示文本（用于显示）\n  const getDisplayId = (image: ImageInfo): string => {\n    // 如果没有摘要，显示镜像 ID\n    if (image.id.startsWith('sha256:')) {\n      return image.id.slice(7, 19)\n    }\n    return image.id.slice(0, 12)\n  }\n\n  return {\n    // 状态\n    images,\n    normalImages,\n    loading,\n    deleting,\n    downloading,\n    importing,\n\n    // 计算属性\n    totalImages,\n    totalSize,\n    formattedTotalSize,\n    stats,\n    danglingImages,\n\n    // 方法\n    fetchImages,\n    deleteImage,\n    downloadImage,\n    importImage,\n    findImageById,\n    findImagesByTag,\n    isImageDeleting,\n    isImageDownloading,\n    getImageDisplayTag,\n    getDisplayId,\n    isDanglingImage,\n    stopImagesPolling,\n    startImagesPolling,\n  }\n})\n"],"file":"image-Bt3Khyum.js"}