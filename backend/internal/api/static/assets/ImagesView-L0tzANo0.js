import{$ as e,$t as t,Bn as n,F as r,Gt as i,H as a,Jt as o,Kt as s,Ln as c,Qt as l,R as u,Rn as d,U as f,Ut as p,W as m,Wt as h,Yt as g,Z as _,Zt as v,_n as y,a as b,at as x,c as S,cn as C,fn as w,g as T,hn as E,i as ee,in as D,it as O,j as k,kn as A,m as j,n as M,nt as N,o as P,qt as F,s as I,tn as L,un as R,yn as z,z as B}from"./ui-CdsL-WMe.js";import"./common-B7iQJWwr.js";import{n as V,t as H}from"./index-KvlnPhMc.js";import{t as U}from"./useResponsive-C7zPy5Go.js";import{t as W}from"./app-CSclzxOM.js";import{i as G,n as K,r as te,t as ne}from"./TextOutline-DfkX3I5u.js";import{t as re}from"./CalendarOutline-CiA9mbco.js";import{t as ie}from"./CheckmarkCircleOutline-CNxktTN_.js";import{t as ae}from"./CloseCircleOutline-CD61R6IW.js";import{t as q}from"./CloudUploadOutline-BHaW-Y08.js";import{t as J}from"./DownloadOutline-C4KnaRUa.js";import{t as oe}from"./RefreshOutline-DFsFZU2a.js";import{t as se}from"./SearchOutline-DMbt0-Bv.js";import{t as Y}from"./TrashOutline-BLUdX-Eg.js";import{t as ce}from"./container-BbVEwPu1.js";import{l as X,t as le}from"./utils-5F9W9oaT.js";import{t as Z}from"./image-Bt3Khyum.js";import{t as ue}from"./useXhrUpload-DwU_B2wy.js";var Q={xmlns:`http://www.w3.org/2000/svg`,"xmlns:xlink":`http://www.w3.org/1999/xlink`,viewBox:`0 0 512 512`},de=t({name:`ResizeOutline`,render:function(e,t){return R(),g(`svg`,Q,t[0]||=[s(`path`,{fill:`none`,stroke:`currentColor`,"stroke-linecap":`round`,"stroke-linejoin":`round`,"stroke-width":`32`,d:`M304 96h112v112`},null,-1),s(`path`,{fill:`none`,stroke:`currentColor`,"stroke-linecap":`round`,"stroke-linejoin":`round`,"stroke-width":`32`,d:`M405.77 106.2L111.98 400.02`},null,-1),s(`path`,{fill:`none`,stroke:`currentColor`,"stroke-linecap":`round`,"stroke-linejoin":`round`,"stroke-width":`32`,d:`M208 416H96V304`},null,-1)])}});function fe(){let e=Z(),t=ce(),n=r(),i=B(),a=t=>{let r=e.getImageDisplayTag(t),a=e.isDanglingImage(t),o=h(t),s=g(t),c=A(o),l,u;a?(l=`确认删除悬空镜像`,u=`确定要删除悬空镜像 "${r}" 吗？`):(l=`确认删除镜像`,u=o?`镜像 "${r}" 正在被以下容器使用：\n\n${s.map(e=>`• ${e.name}`).join(`
`)}\n\n删除此镜像可能会影响这些容器的运行。`:`确定要删除镜像 "${r}" 吗？`);let d=i.warning({title:l,content:()=>L(k,{vertical:!0},()=>[L(P,{},()=>u),!a&&L(_,{checked:c.value,"onUpdate:checked":e=>{c.value=e}},()=>`强制删除`)].filter(Boolean)),positiveText:`确认删除`,negativeText:`取消`,onPositiveClick:async()=>{try{d.loading=!0;let i=a?!1:c.value;await e.deleteImage(t.id,i),n.success(`镜像 ${r} 删除成功`),d.loading=!1}catch(e){d.loading=!1,n.error(`删除镜像失败: ${e.message}`)}}})},o=()=>{let t=e.danglingImages;if(t.length===0){n.info(`当前没有悬空镜像`);return}i.warning({title:`批量删除悬空镜像`,content:`发现 ${t.length} 个悬空镜像，确定要全部删除吗？`,positiveText:`确认删除`,negativeText:`取消`,onPositiveClick:async()=>{let r=0,i=0;for(let n of t)try{await e.deleteImage(n.id,!1),r++}catch(e){i++,console.error(`删除悬空镜像 ${n.id} 失败:`,e)}r>0&&n.success(`成功删除 ${r} 个悬空镜像`),i>0&&n.warning(`${i} 个悬空镜像删除失败`)}})},s=async()=>{try{await e.fetchImages(),n.success(`镜像列表刷新成功`)}catch(e){n.error(`刷新失败: ${e.message}`)}},c=async t=>{let r=p(t);try{await e.downloadImage(t.id),n.success(`镜像 ${r} 下载成功`)}catch(e){n.error(`下载镜像失败: ${e.message}`)}},l=async t=>{try{await e.importImage(t),n.success(`镜像 ${t.name} 导入成功`)}catch(e){n.error(`导入镜像失败: ${e.message}`)}},u=e=>new Date(e*1e3).toLocaleString(`zh-CN`,{year:`numeric`,month:`2-digit`,day:`2-digit`,hour:`2-digit`,minute:`2-digit`}),d=e=>{let t=Date.now()-e*1e3,n=Math.floor(t/1e3),r=Math.floor(n/60),i=Math.floor(r/60),a=Math.floor(i/24),o=Math.floor(a/30),s=Math.floor(a/365);return s>0?`${s}年前`:o>0?`${o}个月前`:a>0?`${a}天前`:i>0?`${i}小时前`:r>0?`${r}分钟前`:`刚刚`},f=e=>{if(!e.repoTags||e.repoTags.length===0)return`<none>`;let t=e.repoTags.filter(e=>e!==`<none>:<none>`);if(t.length===0)return`<none>`;let n=t[0],r=n.lastIndexOf(`:`);if(r===-1)return`latest`;let i=n.substring(r+1);return!i||i===`latest`?`latest`:t.length>1?`${i} +${t.length-1}`:i},p=e=>{if(!e.repoTags||e.repoTags.length===0)return e.id.startsWith(`sha256:`)?e.id.slice(7,19):e.id.slice(0,12);let t=e.repoTags.filter(e=>e!==`<none>:<none>`);if(t.length===0)return e.id.startsWith(`sha256:`)?e.id.slice(7,19):e.id.slice(0,12);let n=t[0],r=n.lastIndexOf(`:`);return r===-1?n:n.substring(0,r)},m=e=>{if(!e.repoDigests||e.repoDigests.length===0)return e.id.startsWith(`sha256:`)?e.id.slice(7,19):e.id.slice(0,12);let t=e.repoDigests[0].split(`@`);return t.length===2&&t[1].startsWith(`sha256:`)?t[1].slice(7,19):e.id.slice(0,12)},h=e=>g(e).length>0,g=e=>{let n=t.containers,r=e.repoTags||[];return n.filter(e=>{let t=e.image;return!!(r.includes(t)||r.some(e=>{let n=e.split(`@`)[0],r=t.split(`@`)[0],i=n.split(`:`)[0],a=r.split(`:`)[0];return n===r||i===a}))})};return{handleDelete:a,handleDeleteDangling:o,handleRefresh:s,handleDownload:c,handleImport:l,formatCreateTime:u,getImageAge:d,getVersionDisplayText:f,getImageNameOnly:p,getDigestDisplayText:m,isImageInUse:h,getContainersUsingImage:g,getImageUsageText:e=>{let t=g(e);return t.length===0?`未使用`:t.length===1?`被 ${t[0].name} 使用`:`被 ${t.length} 个容器使用`},getImageUsageContainers:e=>g(e).map(e=>e.name)}}var pe={width:`24`,height:`24`,fill:`currentColor`};function $(e,t){return R(),g(`svg`,pe,[...t[0]||=[s(`path`,{d:`M5.5 7A1.5 1.5 0 0 1 4 5.5 1.5 1.5 0 0 1 5.5 4 1.5 1.5 0 0 1 7 5.5 1.5 1.5 0 0 1 5.5 7m15.91 4.58-9-9A2 2 0 0 0 11 2H4a2 2 0 0 0-2 2v7c0 .55.22 1.05.59 1.41l9 9A2 2 0 0 0 13 22a2 2 0 0 0 1.41-.59l7-7A2 2 0 0 0 22 13a2 2 0 0 0-.59-1.42`},null,-1)]])}var me={render:$},he={width:`24`,height:`24`,fill:`currentColor`};function ge(e,t){return R(),g(`svg`,he,[...t[0]||=[s(`path`,{d:`M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2m0 2a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8m0 2a6 6 0 0 0-6 6 6 6 0 0 0 6 6 6 6 0 0 0 6-6 6 6 0 0 0-6-6`},null,-1)]])}var _e={render:ge},ve={width:`24`,height:`24`,fill:`currentColor`};function ye(e,t){return R(),g(`svg`,ve,[...t[0]||=[s(`path`,{d:`M19 3h-1V1h-2v2H8V1H6v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2m0 16H5V8h14z`},null,-1)]])}var be={render:ye},xe={class:`image-card`},Se={class:`card-header`},Ce={class:`image-name`},we={class:`status-tags`},Te={class:`tag-section`},Ee={class:`tag-text`},De={class:`info-list`},Oe={class:`info-item`},ke={class:`info-value`},Ae={class:`info-item`},je={class:`info-value`},Me={class:`info-item`},Ne={class:`info-value`},Pe={class:`card-footer`},Fe=H(t({__name:`ImageCard`,props:{image:{}},emits:[`delete`],setup(t,{emit:r}){let i=t,a=r,u=Z(),d=fe(),p=async()=>{await d.handleDownload(i.image)},m=()=>{a(`delete`,i.image)};return(r,i)=>{let a=O,h=f,_=e;return R(),g(`div`,xe,[s(`div`,Se,[s(`div`,Ce,n(c(d).getImageNameOnly(t.image)),1),s(`div`,we,[c(d).isImageInUse(t.image)?(R(),F(a,{key:0,bordered:!1,round:``,type:`success`,size:`small`},{default:z(()=>[...i[2]||=[v(` 使用中 `,-1)]]),_:1})):o(``,!0)])]),s(`div`,Te,[l(h,{class:`tag-icon`},{default:z(()=>[l(c(me))]),_:1}),s(`span`,Ee,n(c(d).getVersionDisplayText(t.image)),1)]),s(`div`,De,[s(`div`,Oe,[i[3]||=s(`span`,{class:`info-label`},`ID`,-1),s(`span`,ke,n(c(u).getDisplayId(t.image)),1)]),s(`div`,Ae,[l(h,{class:`info-icon`},{default:z(()=>[l(c(_e))]),_:1}),i[4]||=s(`span`,{class:`info-label`},`大小`,-1),s(`span`,je,n(c(le)(t.image.size)),1)]),s(`div`,Me,[l(h,{class:`info-icon`},{default:z(()=>[l(c(be))]),_:1}),i[5]||=s(`span`,{class:`info-label`},`创建时间`,-1),s(`span`,Ne,n(c(d).formatCreateTime(t.image.created)),1)])]),s(`div`,Pe,[l(_,{onClick:i[0]||=()=>p(),ghost:``,size:`small`,class:`download-btn`,loading:c(u).isImageDownloading(t.image.id)},{icon:z(()=>[l(h,null,{default:z(()=>[l(c(J))]),_:1})]),default:z(()=>[i[6]||=v(` 下载 `,-1)]),_:1},8,[`loading`]),l(_,{onClick:i[1]||=()=>m(),type:`error`,ghost:``,size:`small`,class:`delete-btn`,loading:c(u).isImageDeleting(t.image.id)},{icon:z(()=>[l(h,null,{default:z(()=>[l(c(Y))]),_:1})]),default:z(()=>[i[7]||=v(` 删除 `,-1)]),_:1},8,[`loading`])])])}}}),[[`__scopeId`,`data-v-2e9f6764`]]),Ie={class:`import-content`},Le={class:`upload-area`},Re={key:0,class:`upload-progress`},ze={class:`progress-info`},Be={class:`progress-details`},Ve=H(t({__name:`ImageImportModal`,props:{show:{type:Boolean},showModifiers:{}},emits:D([`success`],[`update:show`]),setup(t,{emit:i}){let a=M(),d=V(),p=()=>X(q,{color:a.value.primaryColor,size:20}),m=E(t,`show`),h=i,_=r(),x=A(),S=A([]),{uploading:C,uploadProgress:w,uploadedSize:D,totalSize:O,currentFileName:j,uploadSpeed:N,resetState:L,upload:B,formatFileSize:H}=ue();y(m,e=>{e&&(S.value=[],L())});let U=e=>{S.value=e},W=e=>{let{file:t}=e;return t.name?.endsWith(`.tar`)?t.file&&t.file.size>5*1024*1024*1024?(_.error(`文件大小不能超过 5GB`),!1):!0:(_.error(`请选择 .tar 格式的镜像文件`),!1)},G=async e=>{let{file:t,onFinish:n,onError:r}=e;if(!t.file){r();return}try{await B({url:`/api/v1/images/import`,file:t.file,getToken:()=>d.getToken(),onSuccess:()=>{n(),h(`success`),m.value=!1},onError:()=>{r()}})}catch(e){console.error(`导入镜像失败:`,e),r()}},K=()=>{C.value||(m.value=!1)};return(t,r)=>{let i=f,a=P,d=I,h=b,_=ee,y=T,E=k,A=e,M=u;return R(),F(M,{show:m.value,"onUpdate:show":r[0]||=e=>m.value=e,icon:p(),preset:`dialog`,style:{padding:`12px`,width:`90vw`,"max-width":`600px`}},{header:z(()=>[...r[1]||=[s(`span`,null,`导入镜像`,-1)]]),action:z(()=>[l(E,{justify:`end`},{default:z(()=>[l(A,{onClick:K,disabled:c(C)},{default:z(()=>[v(n(c(C)?`上传中...`:`取消`),1)]),_:1},8,[`disabled`])]),_:1})]),default:z(()=>[s(`div`,Ie,[l(_,{ref_key:`uploadRef`,ref:x,max:1,"file-list":S.value,"custom-request":G,accept:`.tar`,"show-file-list":!1,"directory-dnd":``,"onUpdate:fileList":U,onBeforeUpload:W},{default:z(()=>[l(h,null,{default:z(()=>[s(`div`,Le,[l(i,{size:`48`,depth:3},{default:z(()=>[l(c(q))]),_:1}),l(a,{class:`upload-title`},{default:z(()=>[...r[2]||=[v(` 点击或者拖动文件到该区域来上传 `,-1)]]),_:1}),l(d,{depth:`3`,class:`upload-hint`},{default:z(()=>[...r[3]||=[v(` 仅支持 .tar 格式的 Docker 镜像文件 `,-1)]]),_:1})])]),_:1})]),_:1},8,[`file-list`]),c(C)?(R(),g(`div`,Re,[l(E,{vertical:``},{default:z(()=>[s(`div`,ze,[l(a,null,{default:z(()=>[v(n(c(j)),1)]),_:1}),l(a,{depth:`3`},{default:z(()=>[v(n(c(H)(c(D)))+` / `+n(c(H)(c(O))),1)]),_:1})]),l(y,{type:`line`,percentage:c(w),"show-indicator":!1,height:8},null,8,[`percentage`]),s(`div`,Be,[l(a,{depth:`3`},{default:z(()=>[v(n(c(w).toFixed(1))+`% - `+n(c(N)),1)]),_:1})])]),_:1})])):o(``,!0)])]),_:1},8,[`show`,`icon`])}}}),[[`__scopeId`,`data-v-10a8363f`]]),He={class:`images-page`},Ue={class:`images-content`},We={key:0,class:`empty-state`},Ge={class:`welcome-card`},Ke=H(t({__name:`ImagesView`,setup(t){let o=Z(),u=ce(),_=fe(),{isMobile:y,isTablet:b,isLaptop:T,isDesktop:E,isDesktopLarge:ee}=U(),D=r(),O=W(),M=A(!1),I=A(``),L=A(null),B=A(`created`),V=A(`desc`),H=i(()=>[{label:`全部`,key:null,icon:X(G)},{label:`使用中`,key:`in-use`,icon:X(ie)},{label:`未使用`,key:`unused`,icon:X(ae)}]),J=i(()=>B.value!==`created`||V.value!==`desc`),Y=i(()=>[{label:`名称 ${B.value===`name`?V.value===`asc`?`↑`:`↓`:``}`,key:`name`,icon:X(ne)},{label:`大小 ${B.value===`size`?V.value===`asc`?`↑`:`↓`:``}`,key:`size`,icon:X(de)},{label:`创建时间 ${B.value===`created`?V.value===`asc`?`↑`:`↓`:``}`,key:`created`,icon:X(re)}]),le=e=>{L.value=e},ue=e=>{B.value===e?V.value=V.value===`asc`?`desc`:`asc`:(B.value=e,V.value=`asc`)},Q=i(()=>{let e=[...o.normalImages];if(I.value){let t=I.value.toLowerCase();e=e.filter(e=>{let n=o.getImageDisplayTag(e).toLowerCase(),r=e.id.toLowerCase(),i=e.repoTags?.join(` `).toLowerCase()||``;return n.includes(t)||r.includes(t)||i.includes(t)})}return L.value&&(e=e.filter(e=>{let t=_.isImageInUse(e);switch(L.value){case`in-use`:return t;case`unused`:return!t;default:return!1}})),e.sort((e,t)=>{let n=0;switch(B.value){case`name`:let r=o.getImageDisplayTag(e).toLowerCase(),i=o.getImageDisplayTag(t).toLowerCase();n=r.localeCompare(i);break;case`size`:n=e.size-t.size;break;case`created`:n=e.created-t.created;break;default:return 0}return V.value===`asc`?n:-n})}),pe=async e=>{await _.handleDelete(e)},$=async()=>{O.systemHealth===`unhealthy`&&await O.checkHealth(),await _.handleRefresh(),await u.fetchContainers(!0,!0)},me=async()=>{await o.fetchImages(),await u.fetchContainers(!0,!1),D.success(`镜像导入成功`)};return C(async()=>{o.images.length===0&&await o.fetchImages(),u.containers.length===0&&await u.fetchContainers()}),(t,r)=>{let i=f,u=e,_=a,C=N,D=k,O=x,A=j,B=S,V=P,U=m;return R(),g(`div`,He,[l(D,null,{default:z(()=>[l(_,{options:H.value,onSelect:le},{default:z(()=>[l(u,{circle:``,size:`small`,type:L.value?`primary`:`default`},{icon:z(()=>[l(i,null,{default:z(()=>[l(c(te))]),_:1})]),_:1},8,[`type`])]),_:1},8,[`options`]),l(_,{options:Y.value,onSelect:ue},{default:z(()=>[l(u,{circle:``,size:`small`,type:J.value?`primary`:`default`},{icon:z(()=>[l(i,null,{default:z(()=>[l(c(K))]),_:1})]),_:1},8,[`type`])]),_:1},8,[`options`]),l(C,{value:I.value,"onUpdate:value":r[0]||=e=>I.value=e,placeholder:`搜索镜像标签或ID`,style:{width:`200px`},clearable:``},{prefix:z(()=>[l(i,null,{default:z(()=>[l(c(se))]),_:1})]),_:1},8,[`value`])]),_:1}),s(`div`,Ue,[l(A,{show:c(o).loading&&Q.value.length===0},{default:z(()=>[Q.value.length===0&&!c(o).loading?(R(),g(`div`,We,[l(O,{description:`没有找到镜像`},{extra:z(()=>[l(u,{onClick:$},{default:z(()=>[...r[3]||=[v(`刷新数据`,-1)]]),_:1})]),_:1})])):(R(),g(`div`,{key:1,class:d([`images-grid`,{"grid-cols-1":c(y),"grid-cols-2":c(b),"grid-cols-3":c(T)||c(E),"grid-cols-4":c(ee)}])},[(R(!0),g(p,null,w(Q.value,e=>(R(),F(Fe,{key:e.id,image:e,onDelete:pe},null,8,[`image`]))),128))],2))]),_:1},8,[`show`])]),(R(),F(h,{to:`#header`,defer:``},[s(`div`,Ge,[s(`div`,null,[l(B,{class:`m-0 text-lg`},{default:z(()=>[...r[4]||=[v(`镜像管理`,-1)]]),_:1}),l(V,{depth:`3`,class:`text-xs max-md:hidden`},{default:z(()=>[v(` 共 `+n(c(o).stats.total)+` 个镜像， 总大小 `+n(c(o).stats.formattedTotalSize)+`， `,1)]),_:1})]),l(D,{size:`small`},{default:z(()=>[l(u,{onClick:$,loading:c(o).loading,circle:``,size:`tiny`},{icon:z(()=>[l(c(oe))]),_:1},8,[`loading`]),l(U,{trigger:`hover`,delay:500},{trigger:z(()=>[l(u,{onClick:r[1]||=e=>M.value=!0,circle:``,size:`tiny`},{icon:z(()=>[l(c(q))]),_:1})]),default:z(()=>[r[5]||=v(` 镜像导入 `,-1)]),_:1})]),_:1})])])),l(Ve,{show:M.value,"onUpdate:show":r[2]||=e=>M.value=e,onSuccess:me},null,8,[`show`])])}}}),[[`__scopeId`,`data-v-f6fd3be1`]]);export{Ke as default};
//# sourceMappingURL=ImagesView-L0tzANo0.js.map